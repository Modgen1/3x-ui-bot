import requests
import json
from aiogram import Router
from aiogram.types import Message
from aiogram.filters import Command
from config_reader import config

router = Router()
s = requests.Session()
admin_id = int(config.admin_id.get_secret_value())
panel_url = ('https://' + config.panel_host.get_secret_value() + ':' + config.panel_port.get_secret_value() +
             config.panel_uri_path.get_secret_value())
server_url = config.server_url.get_secret_value()


@router.message(Command('start'))
async def start_handler(message: Message):
    await message.reply(f'üìå–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –º–æ–µ–≥–æ –í–ü–ù:\n\n'
                        f'–î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤–∞–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Hiddify.\n- –ï—Å–ª–∏ –≤—ã –ø–æ–ª—å–∑—É–µ—Ç–µ—Å—å –∞–π—Ñ–æ–Ω–æ–º, —Ç–æ '
                        f'—É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –∏–∑ App Store, –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ <a '
                        f'href="https://github.com/hiddify/hiddify-app/releases/tag/v2.5.7">—Å—Å—ã–ª–∫–µ</a> –∏ —Å–∫–∞—á–∞–π—Ç–µ, '
                        f'–≤—ã–±—Ä–∞–≤ –≤–∞—à—É —Å–∏—Å—Ç–µ–º—É.\n- –ó–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ–º—É –±–æ—Ç—É –∫–æ–º–∞–Ω–¥—É /get, –∫–æ—Ç–æ—Ä–∞—è —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥–ª—è –≤–∞—Å '
                        f'–ª–∏—á–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.\n- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ—ë, –∞ –∑–∞—Ç–µ–º –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Hiddify, –≥–¥–µ '
                        f'–Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞.\n\n–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –≤—ã –º–æ–∂–µ—Ç–µ —Å–≤–æ–±–æ–¥–Ω–æ'
                        f' –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∏ –æ—Ç–∫–ª—é—á–∞—Ç—å—Å—è –æ—Ç –í–ü–ù –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.\n\nüíå–ü–æ –ª—é–±—ã–º –≤–æ–ø—Ä–æ—Å–∞–º –Ω–µ —Å—Ç–µ—Å–Ω—è—Ç—å—Å—è '
                        f'–æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ @mishin_iv\n\nüí∏–û–ø–ª–∞—Ç–∞:\n–î–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ —è –±–µ—Ä—É –ø–æ 150 —Ä—É–±–ª–µ–π –≤ –º–µ—Å—è—Ü —Å '
                        f'–∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ª–∏–±–æ –±–æ–ª—å—à–µ, –µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –º–µ–Ω—è –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å). –£–¥–æ–±–Ω–µ–µ –≤—Å–µ–≥–æ –µ—Å–ª–∏ –≤—ã '
                        f'–Ω–∞—Å—Ç—Ä–æ–µ—Ç–µ –∞–≤—Ç–æ–ø–µ—Ä–µ–≤–æ–¥ —Ä–∞–∑ –≤ –º–µ—Å—è—Ü –ø–æ –Ω–æ–º–µ—Ä—É +79775127643 (–ò–≤–∞–Ω –°–µ—Ä–≥–µ–µ–≤–∏—á –ú–∏—à–∏–Ω).\n\n‚úçÔ∏è'
                        f'–ù–µ—Å–∫–æ–ª—å–∫–æ –¥–µ—Ç–∞–ª–µ–π:\n1. –¢–µ–ø–µ—Ä—å –≤—Å–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∏ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –≤–∞—à–µ–º—É '
                        f'–∞–π–¥–∏ —Ç–µ–ª–µ–≥—Ä–∞–º–∞, –ø–æ—ç—Ç–æ–º—É –µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –í–ü–ù–æ–º —Å –∫–µ–º-—Ç–æ –¥—Ä—É–≥–∏–º, –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–º '
                        f'—ç—Ç–æ–≥–æ –±–æ—Ç–∞, —á—Ç–æ–±—ã –æ–Ω–∏ —Å–∞–º–∏ –ø–æ–ª—É—á–∏–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É.\n2. –î–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –í–ü–ù–∞, –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç'
                        f' —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–∞–π—Ç—ã –≤–Ω–µ –†–§, —Ç–∞–∫ —á—Ç–æ –ø—Ä–∏ –∑–∞—Ö–æ–¥–µ –Ω–∞ —Ä—É—Å—Å–∫–∏–µ —Å–∞–π—Ç—ã –í–ü–ù –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –Ω–µ –±—É–¥–µ—Ç, '
                        f'–¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω –≤ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç. –≠—Ç–æ —Å–¥–µ–ª–∞–Ω–æ, —á—Ç–æ–±—ã —Å–∞–π—Ç—ã –ø–æ —Ç–∏–ø—É –ì–æ—Å—É—Å–ª—É–≥ –Ω–µ –º–æ–≥–ª–∏ '
                        f'–æ–±–Ω–∞—Ä—É–∂–∏—Ç—å, —á—Ç–æ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –í–ü–ù –∏ –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –º–æ–π —Å–µ—Ä–≤–µ—Ä.\n3. –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —ç—Ç–æ–≥–æ '
                        f'–í–ü–ù–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω –∫–∞–Ω–∞–ª –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –¥–µ–ª–∏—Ç—Å—è –º–µ–∂–¥—É –≤—Å–µ–º–∏, –ø–æ—ç—Ç–æ–º—É –≤ –º–æ–º–µ–Ω—Ç—ã –ø–∏–∫–æ–≤–æ–π '
                        f'–Ω–∞–≥—Ä—É–∑–∫–∏ —Å–∫–æ—Ä–æ—Å—Ç—å –º–æ–∂–µ—Ç –∏ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –±—É–¥–µ—Ç –ø—Ä–æ—Å–∞–∂–∏–≤–∞—Ç—å—Å—è.\n\n–¢–∞–∫–∂–µ, —É–≤–∞–∂–∞–π—Ç–µ –¥—Ä—É–≥–∏—Ö '
                        f'–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å –ø–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –Ω–µ —Å–∫–∞—á–∏–≤–∞—Ç—å —á—Ç–æ-—Ç–æ –æ—á–µ–Ω—å –æ–±—ä—ë–º–Ω–æ–µ —á–µ—Ä–µ–∑ —ç—Ç–æ—Ç –í–ü–ù, '
                        f'—á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ—Å–∞–∂–∏–≤–∞—Ç—å –¥—Ä—É–≥–∏–º —Å–∫–æ—Ä–æ—Å—Ç—å –≤ –Ω–æ–ª—å.')


async def pbk_sid_handler():
        res = s.get(panel_url + 'panel/api/inbounds/list', verify=False)
        if res.history:
            login_handler()
            res = s.get(panel_url + 'panel/api/inbounds/list', verify=False)
        return (json.loads(res.json()['obj'][1]['streamSettings'])['realitySettings']['settings']['publicKey'],
                json.loads(res.json()['obj'][1]['streamSettings'])['realitySettings']['shortIds'][0])


@router.message(Command('get'))
async def get_handler(message: Message):
    template = {"id": 3, "settings": "{\"clients\": [{\"id\": \"" + f'{message.from_user.username}' + "\",\"flow\": \"xtls-rprx-vision\",\"email\": \"" + f'{message.from_user.username}' + "\",\"limitIp\": 0,\"totalGB\": 0,\"expiryTime\": 0,\"enable\": true,\"tgId\": \"" + f'{message.from_user.id}' + "\",\"subId\": \"286397\",\"reset\": 0}]}"}
    res = s.post(panel_url + 'panel/api/inbounds/addClient', data=template, verify=False)
    if res.history:
        login_handler()
        s.post(panel_url + 'panel/api/inbounds/addClient', data=template, verify=False)
    pbk, sid = await pbk_sid_handler()
    await message.reply(f'–í–∞—à–∞ —Å—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:\n<pre>vless://{message.from_user.username}@{server_url}:443?'
                        f'type=tcp&security=reality&pbk={pbk}&fp=chrome&sni=modgen.nl&sid={sid}&spx=%2F&'
                        f'flow=xtls-rprx-vision#{message.from_user.username}</pre>\n'
                        f'–í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ Hiddify –≤—ã–±–µ—Ä–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞, —á—Ç–æ–±—ã —ç—Ç–∞ —Å—Å—ã–ª–∫–∞ '
                        f'–¥–æ–±–∞–≤–∏–ª–∞—Å—å. –ü—Ä–∏ –ª—é–±—ã—Ö –æ—à–∏–±–∫–∞—Ö –∏ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—è—Ö –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ @mishin_iv')


def login_handler():
    s.post(panel_url + 'login', verify=False, data={
        'username': config.panel_login.get_secret_value(),
        'password': config.panel_password.get_secret_value()})
